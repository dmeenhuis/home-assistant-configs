start_spotify:
  alias: Start Spotify
  description: Start a Spotify playlist on Denon media player
  fields:
    playlist:
      description: The playlist URI from Spotify
      example: 7kSU1hAXAqbAL0B3EuwuvZ
  sequence:
  - service: homeassistant.update_entity
    entity_id: media_player.spotify
  - wait_template: '{{ source in state_attr("media_player.spotify", "source_list")  }}'
    timeout: 00:01:00
    continue_on_timeout: 'false'
  - service: media_player.select_source
    entity_id: media_player.spotify
    data:
      source: 'Denon AVR-X1300W'
  - delay:
      seconds: 12   # wait for the device to be properly started
  - wait_template: '{{ is_state("media_player.denon_avr_x1300w", "on") }}'
    timeout: 00:01:00
    continue_on_timeout: 'false'
  - service: spotify.play_playlist
    data_template:
      media_content_id: spotify:playlist:{{ playlist }}
      random_song: true
  - service: media_player.media_play
    entity_id: media_player.spotify
